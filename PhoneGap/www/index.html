<!DOCTYPE html>
<!--
    Copyright (c) 2012-2014 Adobe Systems Incorporated. All rights reserved.

    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
     KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.
-->
<html>
<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />
    <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
    <link rel="stylesheet" type="text/css" href="css/index.css" />
    <link rel="stylesheet" type="text/css" href="css/ratchet-theme-ios.min.css" />
    <link rel="stylesheet" type="text/css" href="css/ratchet.min.css" />
    <link rel="stylesheet" type="text/css" href="css/ggmap.css" />
    <link rel="stylesheet" type="text/css" href="css/temp.css" id="tempCss" />

    <link rel="stylesheet" href="css/bootstrap.min.css">
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>

    <title>Hello World</title>
</head>
<body>
<div id="popover" data-toggle="popover">
    <header class="bar bar-nav">
        <h1 class="title">Sharing option</h1>
    </header>
    <ul class="table-view">
        <li class="table-view-cell">
            <a onclick="onFacebookButtonClick();">
                <img class="media-object pull-left" src="img/facebook.png">
                <span>Facebook</span>
            </a>
        </li>
        <li class="table-view-cell">
            <a onclick="onTwitterButtonClick();">
                <img class="media-object pull-left" src="img/twitter.png">
                <span>Twitter</span>
            </a>
        </li>
    </ul>
</div>
<!--List header-->
<header id="homeHeader" class="bar bar-nav">
    <span class="pull-right icon icon-plus" id="buttonAddEvent"></span>
    <h1 class="title">Home</h1>
</header>
<header id="detailHeader" class="bar bar-nav">
    <span class="pull-left icon icon-home" id="buttonHome"></span>
    <span class="pull-right icon icon-share" id="buttonShare" data-placement="bottom"></span>
    <h1 class="title">Detail</h1>
</header>
<header id="addNewHeaderS1" class="bar bar-nav">
    <span class="pull-left icon icon-home" id="buttonHomeFromAdd"></span>
    <h1 id="eventEditFormTitle" class="title">Add New Event</h1>
</header>
<header id="addNewHeaderS2" class="bar bar-nav">
    <h1 class="title">Add New Event</h1>
</header>

<!--Div main content-->
<div id="mainContainer" class="content">

    <div id="divNoEvents" class="content-padded">
        <h2>Create your event now</h2>
    </div>

    <div id="map"></div>
    <div id="divEvents" class="content-padded">
        <div class="dropdown" style="display: inline; width: 19%">
            <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Order
                <span class="caret"></span></button>
            <ul class="dropdown-menu">
                <li><a href="#" id="orderDate" onclick="changeOrder(1);">Event Date</a></li>
                <li><a href="#" id="orderName" onclick="changeOrder(2);">Event Name</a></li>
            </ul>
        </div>
        <input id="txtSearchEvent" type="search" placeholder="Search Event" style="display: inline;width: 80%">
        <div id="divWrapperEvent" class="container-fluid">
            <div id="eventRows" class="row"></div>
        </div>
    </div>

    <div id="divEventInfo" class="content-padded">
        <h3 id="labelEventName">FPT Festival</h3>
        <h6 id="labelEventDate">
            Thursday, September 26, 2013 at 2 PM - 5 PM
            <br>
            About a week left
        </h6>
    </div>

    <div id="divSlider" class="slider">
    </div>

    <div id="divComments">
    </div>

    <nav id="navComment" class="bar bar-tab">
        <div id="divEventFooter" class="content-padded">
            <table id="tableComment">
                <tr>
                    <td id="tdCamera">
                        <button id="buttonCamera" class="btn-positive" onclick="takePicture();">Capture</button>
                    </td>
                    <td id="tdCommentBox">
                        <input id="txtComment" type="text" placeholder="Your comment">
                    </td>
                    <td id="tdSendButton">
                        <button id="buttonComment" class="btn-positive" onclick="takeComment();">Send</button>
                    </td>
                </tr>
            </table>
        </div>
        <div id="addStepButton" class="content-padded">
            <button id="buttonNextStep" class="btn btn-positive btn-block">Next</button>
        </div>
    </nav>

    <div id="addStep1" class="content-padded">
        <div class="form-horizontal">
            <div class="form-group">
                <label class="control-label col-sm-2" for="txtAddEventName">Event name:</label>
                <span id="errAddEventName" class="label label-danger">a</span>
                <div class="col-sm-10">
                    <input id="txtAddEventName" class="form-control" type="text" placeholder="Event name"/>
                </div>

            </div>
            <div class="form-group">
                <label class="control-label col-sm-2" for="txtAddEventLocation">Event location:</label>
                <span id="errAddEventLocation" class="label label-danger">a</span>
                <div class="col-sm-10">
                    <input id="txtAddEventLocation" class="form-control" type="text" placeholder="Event location">
                    <input id="locationLat" type="hidden"/>
                    <input id="locationLon" type="hidden"/>
                </div>
            </div>
            <div class="form-group">
                <label class="control-label col-sm-2" for="txtAddEventDate">Event date:</label>
                <span id="errAddEventDate" class="label label-danger">a</span>
                <div class="col-sm-10">
                    <input id="txtAddEventDate" class="form-control" type="date" placeholder="Event date">
                </div>
            </div>
            <div class="form-group">
                <label class="control-label col-sm-2" for="txtAddEventTime">Event time:</label>
                <span id="errAddEventTime" class="label label-danger">a</span>
                <div class="col-sm-10">
                    <input id="txtAddEventTime" class="form-control" type="time" placeholder="Event time">
                </div>
            </div>
            <div class="form-group">
                <label class="control-label col-sm-2" for="txtAddEventOrg">Event organizer name:</label>
                <span id="errAddEventOrg" class="label label-danger">a</span>
                <div class="col-sm-10">
                    <input id="txtAddEventOrg" class="form-control" type="text" placeholder="Organizer name">
                </div>
            </div>
            <div class="form-group">
                <span id="errAddExisted" class="label label-danger">a</span>
            </div>
        </div>
    </div>

    <div id="addStep2" class="content-padded">
        <div class="content-padded">
            <h1 id="finishLabel" class="centerHorizontally">Your event has been created successfully.</h1>
        </div>
    </div>
</div>

<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript" src="js/ratchet.min.js"></script>
<script type="text/javascript" src="js/push.js"></script>
<script type="text/javascript" src="js/DatabaseContext.js"></script>
<script type="text/javascript" src="js/ggmap.js"></script>
<!--<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA3X4i6Pg9Z6M_PX9rMdP5FmW1NzhEC3VE&libraries=places&callback=initAutocomplete"-->
        <!--async defer></script>-->

<script type="text/javascript">
    // Helps set view correctly
    var templateNames = {
        HOME_NO_EVENTS: 1,
        HOME_HAS_EVENTS: 2,
        DETAILS: 3,
        ADD_STEP_1: 4,
        ADD_STEP_2: 5
    };
    var templates = {};
    templates[templateNames.HOME_NO_EVENTS] = ["divNoEvents", "homeHeader"];
    templates[templateNames.HOME_HAS_EVENTS] = ["divEvents", "divWrapperEvent", "homeHeader"];
    templates[templateNames.DETAILS] = ["divSlider", "divEventFooter", "divEventInfo", "divComments", "detailHeader"];
    templates[templateNames.ADD_STEP_1] = ["addStep1", "addStepButton", "addNewHeaderS1"];
    templates[templateNames.ADD_STEP_2] = ["addStep2", "addStepButton", "addNewHeaderS2"];

    // Add event's step management
    var stepManager = null;
    var selectedTemplate = templateNames.HOME_NO_EVENTS;

    // Select an event
    var selectedEventId = -1;
    var selectedEventToStopId = -1;
    var selectedEventToUpdate = null;
    var firstLoad = true;

    function showStopEventConfirm(eventId, title, msg, ok, cancel, callback) {
        selectedEventToStopId = eventId;
        navigator.notification.confirm(
                msg,
                callback,
                title,
                ok + "," + cancel
        );
    }

    /**
     * Get day's name
     * @param dayIndex
     * @returns {*}
     */
    function getDayName(dayIndex) {
        if (dayIndex == 1) {
            return "Monday";
        } else if (dayIndex == 2) {
            return "Tuesday";
        } else if (dayIndex == 3) {
            return "Wednesday";
        } else if (dayIndex == 4) {
            return "Thursday";
        } else if (dayIndex == 5) {
            return "Friday";
        } else if (dayIndex == 6) {
            return "Saturday";
        } else if (dayIndex == 7) {
            return "Sunday";
        }
        return "null";
    }

    /**
     * Get month's name
     * @param monthIndex
     * @returns {*}
     */
    function getMonthName(monthIndex) {
        if (monthIndex == 0) {
            return "January";
        } else if (monthIndex == 1) {
            return "February";
        } else if (monthIndex == 2) {
            return "March";
        } else if (monthIndex == 3) {
            return "April";
        } else if (monthIndex == 4) {
            return "May";
        } else if (monthIndex == 5) {
            return "June";
        } else if (monthIndex == 6) {
            return "July";
        } else if (monthIndex == 7) {
            return "August";
        } else if (monthIndex == 8) {
            return "September";
        } else if (monthIndex == 9) {
            return "October";
        } else if (monthIndex == 10) {
            return "November";
        } else if (monthIndex == 11) {
            return "December";
        }
        return "null";
    }

    /**
     * Get hour's name
     * @param hourValue
     * @param minuteValue
     * @returns {*}
     */
    function getHourName(hourValue, minuteValue) {
        hourValue--;
        var hourMod = hourValue % 12;
        var hourVal = Math.floor(hourValue / 12);

        var minutes = minuteValue < 10 ? '0' + minuteValue : minuteValue;
        var hours = (hourMod + 1) < 10 ? '0' + (hourMod + 1) : (hourMod + 1);
        if (hourVal > 0) {
            return hours + ":" + minutes + " PM";
        } else {
            return hours + ":" + minutes + " AM";
        }
        return "null";
    }

    /**
     * Turn off screen
     */
    function setTemplateOff () {
        for (var i in templates) {
            var listElements = templates[i];
            for (var idx in listElements) {
                var elementId = listElements[idx];
                var element = document.getElementById(elementId);
                if (element == null) {
                    alert("Element not found");
                } else {
                    element.style.display = 'none';
                    element.style.visibility = 'hidden';
                }
            }
        }
    }

    /**
     * Prepare form to create/edit
     * @param isNew
     */
    function prepareForm(isNew) {
        setTemplate(templateNames.ADD_STEP_1);
        stepManager = {};
        stepManager.step = 1;

        var eventEditFormTitle = document.getElementById("eventEditFormTitle");
        var buttonNextStep = document.getElementById("buttonNextStep");
        if (isNew) {
            eventEditFormTitle.innerHTML = "Add New Event";
            buttonNextStep.innerHTML = "Create";
        } else {
            eventEditFormTitle.innerHTML = "Edit Event";
            buttonNextStep.innerHTML = "Update";
        }

        // invisible error labels
        $("#addStep1 div div span").each(function() {
            $(this).toggle(false);
        });
    }

    /**
     * Format the date for value in text box
     * @param date
     * @returns {string}
     */
    function formatDate(date) {
        var retVal = "";
        retVal = retVal.concat(date.getFullYear());
        retVal = retVal.concat("-");

        var months = date.getMonth() + 1;
        months = months < 10 ? '0' + months : months;
        retVal = retVal.concat(months);
        retVal = retVal.concat("-");

        var dates = date.getDate() < 10 ? '0' + date.getDate() : date.getDate();
        retVal = retVal.concat(dates);

        return retVal;
    }

    /**
     * Format the time for value in text box
     * @param date
     * @returns {string}
     */
    function formatTime(date) {
        var retVal = "";

        var hours = date.getHours() < 10 ? '0' + date.getHours() : date.getHours();
        retVal = retVal.concat(hours);
        retVal = retVal.concat(":");

        var minutes = date.getMinutes() < 10 ? '0' + date.getMinutes() : date.getMinutes();
        retVal = retVal.concat(minutes);

        return retVal;
    }

    /**
     * Display text in short version
     * @param txt
     * @param limit
     */
    function displayShortVersion(txt, limit) {
        if (txt.length <= limit) {
            return txt;
        } else {
            return txt.substring(0, limit) + "...";
        }
    }

    /**
     * Toggle screen
     * @param templateName
     */
    function setTemplate(templateName) {
        selectedTemplate = templateName;
        for (var i in templates) {
            if (i != templateName) {
                var listElements = templates[i];
                for (var idx in listElements) {
                    var elementId = listElements[idx];
                    var element = document.getElementById(elementId);
                    if (element == null) {
                        alert("Element not found " + elementId);
                    } else {
                        element.style.display = 'none';
                        element.style.visibility = 'hidden';
                    }
                }
            }
        }

        var listElements = templates[templateName];
        for (var idx in listElements) {
            var elementId = listElements[idx];
            var element = document.getElementById(elementId);
            if (element == null) {
                alert("Element not found");
            } else {
                element.style.display = 'block';
                element.style.visibility = 'visible';
            }
        }
    }

    /***
     * Reset form add
     */
    function resetFormAdd() {
        document.getElementById("txtAddEventName").value = "";
        document.getElementById("txtAddEventLocation").value = "";
        document.getElementById("locationLat").value = "";
        document.getElementById("locationLon").value = "";

        var today = new Date();
        document.getElementById("txtAddEventDate").value = formatDate(today);
        document.getElementById("txtAddEventTime").value = formatTime(today);
        document.getElementById("txtAddEventOrg").value = "";
    }

    /***
     * Populate form add
     */
    function populateFormAdd(eventName, eventLocation, locationLat, locationLon, eventDate, eventTime, eventOrg) {
        document.getElementById("txtAddEventName").value = eventName;
        document.getElementById("txtAddEventLocation").value = eventLocation;
        document.getElementById("locationLat").value = locationLat;
        document.getElementById("locationLon").value = locationLon;
        document.getElementById("txtAddEventDate").value = eventDate;
        document.getElementById("txtAddEventTime").value = eventTime;
        document.getElementById("txtAddEventOrg").value = eventOrg;
    }

    /**
     * View an event
     * @param rs
     */
    function viewEvent(rs) {
        var divSlider = document.getElementById("divSlider");
        divSlider.innerHTML = "";
        var selectedEvent = rs.rows.item(0);
        selectedEventId = selectedEvent.EventId;

        var eventDate = new Date(parseInt(selectedEvent.EventDate));
        if (eventDate == "Invalid Date") {
            alert("Invalid Date");
        } else {
            updateDetailsUI(selectedEvent.EventName, eventDate);
        }

        getListImageReport(selectedEventId, updateImageReportUI);
        getListTextReport(selectedEventId, updateTextReportUI);
        setTemplate(templateNames.DETAILS);
    }

    /**
     * Edit an event
     * @param rs
     */
    function editEvent(rs) {
        selectedEventToUpdate = rs.rows.item(0);
        var eventName = selectedEventToUpdate.EventName;
        var eventDate = new Date(parseInt(selectedEventToUpdate.EventDate));
        var eventLocation = selectedEventToUpdate.EventLocation;
        var eventLat = selectedEventToUpdate.EventLat;
        var eventLon = selectedEventToUpdate.EventLon;
        var eventOrg = selectedEventToUpdate.EventOrgName;

        populateFormAdd(eventName, eventLocation, eventLat, eventLon, formatDate(eventDate), formatTime(eventDate), eventOrg);
        prepareForm(false);
    }

    /**
     * Adjust an event
     * @param stepManager
     */
    function adjustEvent(stepManager) {
        if (stepManager != null) {
            var eName = stepManager["txtAddEventName"];

            var eLoc = stepManager["txtAddEventLocation"];
            var locationLat = stepManager["locationLat"];
            var locationLon = stepManager["locationLon"];

            var eDate = stepManager["txtAddEventDate"];
            var eTime = stepManager["txtAddEventTime"];
            var eOrg = stepManager["txtAddEventOrg"];

            var parsedDate = new Date(eDate);
            var dateFrom1970 = parsedDate.getTime() + eTime + (parsedDate.getTimezoneOffset() * 60 * 1000);

            var props = {};
            props.EventName = eName;
            props.EventLocation = eLoc;
            props.EventLat = locationLat;
            props.EventLon = locationLon;
            props.EventDate = dateFrom1970;
            props.EventOrgName = eOrg;

            updateEvent(selectedEventToUpdate.EventId, props, finalStep);
        }
    }

    /**
     * Create an event
     * @param stepManager
     */
    function createNewEvent(stepManager) {
        if (stepManager != null) {
            var eName = stepManager["txtAddEventName"];

            var eLoc = stepManager["txtAddEventLocation"];
            var locationLat = stepManager["locationLat"];
            var locationLon = stepManager["locationLon"];

            var eDate = stepManager["txtAddEventDate"];
            var eTime = stepManager["txtAddEventTime"];
            var eOrg = stepManager["txtAddEventOrg"];

            var parsedDate = new Date(eDate);
            var dateFrom1970 = parsedDate.getTime() + eTime + (parsedDate.getTimezoneOffset() * 60 * 1000);
            insertEvent(eName, eLoc, locationLat, locationLon, dateFrom1970, eOrg, finalStep);
        }
    }

    /**
     * Callback of creating event
     */
    function finalStep() {
        var buttonNextStep = document.getElementById("buttonNextStep");
        buttonNextStep.innerHTML = "Finish";

        var finishLabel = document.getElementById("finishLabel");
        if (selectedEventToUpdate != null) {
            finishLabel.innerHTML = "Your event has been updated successfully.";
        } else {
            finishLabel.innerHTML = "Your event has been created successfully.";
        }

//        if (map != null) {
//            google.maps.event.trigger(map, 'resize');
//        }
        setTemplate(templateNames.ADD_STEP_2);
        stepManager.step = 2;
    }

    /**
     * Report by image
     */
    function takePicture() {
        var cameraOptions = {
            quality: 50,
            saveToPhotoAlbum: true
        };
        navigator.camera.getPicture(cameraSuccess, cameraError, cameraOptions);
        function cameraSuccess(imageData) {
            insertPhotoReport(selectedEventId, imageData, onInsertedPhoto);
        }

        function cameraError(msg) {
            if (msg == "no image selected") {
                return;
            }
            alert("Error " + msg)
        }
    }

    /**
     * Report by text
     */
    function takeComment() {
        var txtComment = document.getElementById("txtComment");
        if (txtComment != null) {
            var commentString = txtComment.value;
            if (!commentString.trim()) {
                txtComment.value = "";
                alert("Nothing to note");
                return;
            }
            txtComment.value = "";
            insertTextReport(selectedEventId, commentString, onInsertedComment);
        }
    }

    // Refresh
    /**
     * Get time left
     * @param startDateSince1970
     */
    function getTimeLeft(startDateSince1970) {
        var retVal = "";
        var todayDate = new Date();
        var startDate = new Date(startDateSince1970);
        var dateDiffInInteger = startDate - todayDate;
        if (dateDiffInInteger > 0) {
            // still has time
            var secondDiff = Math.floor(dateDiffInInteger / 1000);
            var minuteDiff = Math.floor(dateDiffInInteger / 1000 / 60);
            var hourDiff = Math.floor(dateDiffInInteger / 1000 / 60 / 60);
            var dayDiff =  Math.floor(dateDiffInInteger / 1000 / 60 / 60 / 24);
            var monthDiff = Math.floor(dateDiffInInteger / 1000 / 60 / 60 / 24 / 30);
            var yearDiff =  Math.floor(dateDiffInInteger / 1000 / 60 / 60 / 24 / 30 / 365);

            if (yearDiff > 0) {
                retVal = "About more than one year left";
            } else if (monthDiff > 0) {
                retVal = "About " + monthDiff + " month(s) left";
            } else if (dayDiff > 0) {
                if (dayDiff > 24) {
                    retVal = "About 3 week(s) left";
                } else if (dayDiff > 17) {
                    retVal = "About 2 week(s) left";
                } else if (dayDiff > 10) {
                    retVal = "About 1 week(s) left";
                } else {
                    retVal = "About " + dayDiff + " day(s) left";
                }
            } else if (hourDiff > 0) {
                retVal = "About " + hourDiff + " hour(s) left";
            } else if (minuteDiff > 0) {
                retVal = "About " + minuteDiff + " minute(s) left";
            } else if (secondDiff > 0) {
                retVal = "Just a couple of second(s) left";
            }
        } else {
            retVal = "Started already";
        }
        return retVal;
    }

    /**
     * Refresh event details
     * @param eventName
     * @param startDateSince1970
     */
    function updateDetailsUI(eventName, startDateSince1970) {
        // set label event name
        var labelEventName = document.getElementById("labelEventName");
        labelEventName.innerHTML = eventName;

        // set label event start date
        var dateFullString = "";
        dateFullString = getDayName(startDateSince1970.getDay()) +
                ", " +
                getMonthName(startDateSince1970.getMonth()) +
                " " +
                startDateSince1970.getDate() +
                ", " +
                startDateSince1970.getFullYear() +
                " at " +
                getHourName(startDateSince1970.getHours(), startDateSince1970.getMinutes());

        dateFullString += "<br/>";
        dateFullString += getTimeLeft(startDateSince1970);

        var labelEventDate = document.getElementById("labelEventDate");
        labelEventDate.innerHTML = dateFullString;
    }

    /**
     * Refresh comments
     * @param rs
     */
    function updateTextReportUI(rs) {
        var divComments = document.getElementById("divComments");
        divComments.innerHTML = "";

        var ulComments = document.createElement("ul");
        ulComments.setAttribute("class", "commentList");
        divComments.appendChild(ulComments);

        var numberOfTextReport = rs.rows.length;
        if (numberOfTextReport == 0) {
            var li = document.createElement("li");

            var div = document.createElement("div");
            div.setAttribute("class", "divNoteNotFound");
            div.innerHTML = "Add a note now";

            li.appendChild(div);
            ulComments.appendChild(li);
        } else {
            if (ulComments != null) {
                for (var i = 0; i < numberOfTextReport; i++) {
                    var li = document.createElement("li");

                    var commentText = document.createElement("div");
                    if (i % 2 == 0) {
                        commentText.setAttribute("class", "commentText evenCell");
                    } else {
                        commentText.setAttribute("class", "commentText oddCell");
                    }
                    {
                        var p = document.createElement("p");
                        p.innerHTML = rs.rows.item(i).Comment;

                        var span = document.createElement("span");
                        span.setAttribute("class", "date sub-text");
                        span.innerHTML = new Date(parseInt(rs.rows.item(i).ReportDate));

                        commentText.appendChild(p);
                        commentText.appendChild(span);
                    }

                    li.appendChild(commentText);

                    ulComments.appendChild(li);
                }
            }
        }
    }

    /**
     * Refresh photos
     * @param rs
     */
    function updateImageReportUI(rs) {
        var divSlider = document.getElementById("divSlider");
        divSlider.innerHTML = "";

        var divImageReport = document.createElement("div");
        divImageReport.setAttribute("class", "slide-group");
        divSlider.appendChild(divImageReport);

        var numberOfImageReport = rs.rows.length;
        if (numberOfImageReport == 0) {
            var div = document.createElement("div");
            div.setAttribute("class", "slide");

            var img = document.createElement("img");
            img.setAttribute("class", "img-responsive");
            img.setAttribute("src", "img/photo.png");

            var span = document.createElement("span");
            span.setAttribute("class", "slide-text");
            span.innerHTML = "Add a photo now";

            div.appendChild(img);
            div.appendChild(span);
            divImageReport.appendChild(div);
        } else {
            for (var i = 0; i < numberOfImageReport; i++) {
                var div = document.createElement("div");
                div.setAttribute("class", "slide");

                var img = document.createElement("img");
                img.setAttribute("class", "img-responsive");
                img.setAttribute("src", rs.rows.item(i).ImgURL);

                div.appendChild(img);
                divImageReport.appendChild(div);
            }
        }
    }

    /**
     * Refresh home
     * @param rs
     */
    function updateHomeUI(rs) {
        if (firstLoad) {
            $("#tempCss").attr("disabled", "disabled");
            if (map != null) {
                google.maps.event.trigger(map, 'resize');
            }
            firstLoad = false;
        }
        // reset selected event to edit
        selectedEventToUpdate = null;
        // reset search string
        document.getElementById("txtSearchEvent").value = "";

        var numberOfEvent = rs.rows.length;
        if (numberOfEvent == 0) {
            setTemplate(templateNames.HOME_NO_EVENTS);
        } else {
            setTemplate(templateNames.HOME_HAS_EVENTS);
            var eventRows = document.getElementById("eventRows");
            eventRows.innerHTML = "";
            var numberOfEvent = rs.rows.length;
            for (var i = 0; i < numberOfEvent; i++) {
                var cell = rs.rows.item(i);
                var eventId = cell.EventId;
                var eventName = cell.EventName;
                var eventDate = new Date(parseInt(rs.rows.item(i).EventDate));
                var eventLocation = cell.EventLocation;
                var eventLat = cell.EventLat;
                var eventLon = cell.EventLon;
                var eventStatus = cell.EventStatus;

                var timeLeft = getTimeLeft(eventDate);
                var displayInfo = eventName + "<br/>" + timeLeft;

                var eventNameDiv = document.createElement("div");
                eventNameDiv.setAttribute("id", "event" + eventId);
                eventNameDiv.setAttribute("class", "col-xs-4");
                eventNameDiv.setAttribute("onclick", "getEventById(" + eventId + ", viewEvent);");

                eventNameDiv.innerHTML = displayInfo;
                eventRows.appendChild(eventNameDiv);
            }

            var maxHeight = 0;
            $("#eventRows div").each(function(){
                if ($(this).height() > maxHeight) { maxHeight = $(this).height(); }
            });

            $("#eventRows div").height(maxHeight);
        }
    }

    // Callback
    function onInsertedPhoto() {
        getListImageReport(selectedEventId, updateImageReportUI);
    }

    function onInsertedComment() {
        getListTextReport(selectedEventId, updateTextReportUI);
    }

    function onButtonHomeClicked() {
        getListEvent(updateHomeUI);
    }

    function onButtonShareClicked() {

    }

    /**
     * Validate form
     */
    function validateForm() {
        // validate form
        stepManager.step = -1;
        var txtAddEventName = document.getElementById("txtAddEventName").value;
        var txtAddEventLocation = document.getElementById("txtAddEventLocation").value;
        var locationLat = document.getElementById("locationLat").value;
        var locationLon = document.getElementById("locationLon").value;
        var txtAddEventDate = document.getElementById("txtAddEventDate").value;
        var txtAddEventTime = document.getElementById("txtAddEventTime").value;
        var txtAddEventOrg = document.getElementById("txtAddEventOrg").value;

        var errAddEventName = $("#errAddEventName");
        var errAddEventLocation = $("#errAddEventLocation");
        var errAddEventDate = $("#errAddEventDate");
        var errAddEventTime = $("#errAddEventTime");
        var errAddEventOrg = $("#errAddEventOrg");
        var errAddExisted = $("#errAddExisted");

        $("#addStep1 div div span").each(function() {
            $(this).toggle(false);
        });

        var isValid = true;
        if (!txtAddEventName.trim()) {
            errAddEventName.html("Event name is required!");
            errAddEventName.toggle(true);
            isValid = false;
        }

        if (!txtAddEventLocation.trim()) {
//            errAddEventLocation.html("Event location is required!");
//            errAddEventLocation.toggle(true);
//            isValid = false;
        } else {
            if (!locationLat.trim() || !locationLon.trim()) {
                errAddEventLocation.html("Location is invalid, location must be selected from suggestion!");
                errAddEventLocation.toggle(true);
                isValid = false;
            }
        }

        var eventDateAndTimeOK = true;
        if (!txtAddEventDate.trim()) {
            errAddEventDate.html("Event date is required!");
            errAddEventDate.toggle(true);
            isValid = false;
            eventDateAndTimeOK = false;
        } else {
            var parsedDate = new Date(txtAddEventDate);
            if (parsedDate == "Invalid Date") {
                errAddEventDate.html("Event date is invalid, eg: 02/12/1964, 2011-06-06...!");
                errAddEventDate.toggle(true);
                isValid = false;
                eventDateAndTimeOK = false;
            }
        }

        if (!txtAddEventTime.trim()) {
            errAddEventTime.html("Event time is required!");
            errAddEventTime.toggle(true);
            isValid = false;
            eventDateAndTimeOK = false;
        } else {
            var timeReg = /^\d{2}[:]\d{2}$/;
            if (!txtAddEventTime.match(timeReg)) {
                errAddEventTime.html("Event time is invalid, eg: 13:20!");
                errAddEventTime.toggle(true);
                isValid = false;
                eventDateAndTimeOK = false;
            } else {
                var partReg = /^(\d{2})[:](\d{2})$/g;
                var match = partReg.exec(txtAddEventTime);
                var hours = parseInt(match[1]);
                var minutes = parseInt(match[2]);
                if (hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
                    errAddEventTime.html("Event time is invalid, eg: 13:20!");
                    errAddEventTime.toggle(true);
                    isValid = false;
                    eventDateAndTimeOK = false;
                }
            }
        }

        if (eventDateAndTimeOK) {
            var parsedDate = new Date(txtAddEventDate);
            var eTime = document.getElementById("txtAddEventTime").valueAsNumber;
            var dateFrom1970 = parsedDate.getTime() + eTime + (parsedDate.getTimezoneOffset() * 60 * 1000);
            var formalDate = new Date(dateFrom1970);

            if (formalDate < new Date()) {
                errAddEventDate.html("Start date is in the past, select the date in future...");
                errAddEventTime.html("... or you must change the hours!");
                errAddEventDate.toggle(true);
                errAddEventTime.toggle(true);
                isValid = false;
            }
        }

        if (!txtAddEventOrg.trim()) {
            errAddEventOrg.html("Event organizer name is required!");
            errAddEventOrg.toggle(true);
            isValid = false;
        }

        if (isValid) {
            isEventExisted(locationLat, locationLon, txtAddEventName, txtAddEventOrg, function (rs) {
                stepManager["txtAddEventName"] = document.getElementById("txtAddEventName").value;
                stepManager["txtAddEventLocation"] = document.getElementById("txtAddEventLocation").value;
                stepManager["locationLat"] = document.getElementById("locationLat").value;
                stepManager["locationLon"] = document.getElementById("locationLon").value;
                stepManager["txtAddEventDate"] = document.getElementById("txtAddEventDate").value;
                stepManager["txtAddEventTime"] = document.getElementById("txtAddEventTime").valueAsNumber;
                stepManager["txtAddEventOrg"] = document.getElementById("txtAddEventOrg").value;

                if (rs.rows.length == 0) {
                    if (selectedEventToUpdate != null) {
                        adjustEvent(stepManager);
                    } else {
                        createNewEvent(stepManager);
                    }
                } else {
                    var isSameRecord = false;
                    if (selectedEventToUpdate != null) {
                        var cell = rs.rows.item(0);
                        if (cell.EventId == selectedEventToUpdate.EventId) {
                            adjustEvent(stepManager);
                            isSameRecord = true;
                        }
                    }

                    if (!isSameRecord) {
                        errAddExisted.html("Adding new event was failed, may be due to: <br/> 1) An event was expected in this place. <br/> 2) Had an event with same both Organizer Name and Event Name already.");
                        errAddExisted.toggle(true);
                        stepManager.step = 1;
                    }
                }
            });
        } else {
            stepManager.step = 1;
        }
    }

    function onButtonNextClicked() {
        if (stepManager.step == 1) {
            validateForm();
        } else if (stepManager.step == 2) {
            getListEvent(updateHomeUI);
            stepManager = null;
        }
    }

    function onEventStopped() {
        getListEvent(updateHomeUI);
    }

    function onButtonAddClicked() {
        resetFormAdd();
        prepareForm(true);
    }

    function onConfirmSelected(buttonIndex) {
        if (buttonIndex == 1) {
            var props = {};
            props.EventStatus = 0;
            updateEvent(selectedEventToStopId, props, onEventStopped);
            selectedEventToStopId = -1;
        }
    }

    var currentOrderEventDateDirection = 1;
    var currentOrderEventNameDirection = 1;
    function changeOrder(fieldIndex) {
        if (fieldIndex == 1) {
            getListEventOrderBy(fieldIndex, currentOrderEventDateDirection, updateHomeUI);
            currentOrderEventDateDirection = currentOrderEventDateDirection == 1 ? 2 : 1;
        } else if (fieldIndex == 2) {
            getListEventOrderBy(fieldIndex, currentOrderEventNameDirection, updateHomeUI);
            currentOrderEventNameDirection = currentOrderEventNameDirection == 1 ? 2 : 1;
        }

        applyOrderForCombobox();
    }

    function onFacebookButtonClick() {
        alert("Function is building");
    }

    function onTwitterButtonClick() {
        alert("Function is building");
    }

    function deviceReady() {
        document.getElementById("buttonAddEvent").addEventListener("click", this.onButtonAddClicked, false);
        document.getElementById("buttonNextStep").addEventListener("click", this.onButtonNextClicked, false);
        document.getElementById("buttonHome").addEventListener("click", this.onButtonHomeClicked, false);
        document.getElementById("buttonHomeFromAdd").addEventListener("click", this.onButtonHomeClicked, false);
        document.getElementById("buttonShare").addEventListener("click", this.onButtonShareClicked, false);

        // init popover
        var elem = document.getElementById("popover");
        $('#buttonShare').popover({animation:true, content:elem, html:true});

        $("*").click(function(e) {
            if (e.target) {
                if ($(e.target).data('placement') != 'bottom') {
                    $('[data-original-title]').popover('hide');
                }
            }
        });

        // init search button
        $('#txtSearchEvent').keyup(function(){
            var searchText = $(this).val();
            $('#eventRows div').each(function() {
                var currentLiText = $(this).text();
                var showCurrentLi = currentLiText.indexOf(searchText) !== -1;
                $(this).toggle(showCurrentLi);

            });
        });

        // disable css
        //$("#tempCss").attr("disabled", "disabled");

        // ... and load google map
        var script = document.createElement("script");
        script.type = "text/javascript";
        script.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyA3X4i6Pg9Z6M_PX9rMdP5FmW1NzhEC3VE&libraries=places&callback=initAutocomplete";
        // Use any selector
        script.async = 1;
        script.defer = 1;
        $("head").append(script);

        setTimeout(function(){
            getListEvent(updateHomeUI);
        }, 2000);

        applyOrderForCombobox();
    }

    function applyOrderForCombobox() {
        // apply order for commbobox
        var orderDateText = currentOrderEventDateDirection == 1 ? "ASC" : "DESC";
        $("#orderDate").html("Event Date<br/>" + orderDateText);

        var orderNameText = currentOrderEventNameDirection == 1 ? "ASC" : "DESC";
        $("#orderName").html("Event Name<br/>" + orderNameText);
    }

    /*
     * Licensed to the Apache Software Foundation (ASF) under one
     * or more contributor license agreements.  See the NOTICE file
     * distributed with this work for additional information
     * regarding copyright ownership.  The ASF licenses this file
     * to you under the Apache License, Version 2.0 (the
     * "License"); you may not use this file except in compliance
     * with the License.  You may obtain a copy of the License at
     *
     * http://www.apache.org/licenses/LICENSE-2.0
     *
     * Unless required by applicable law or agreed to in writing,
     * software distributed under the License is distributed on an
     * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
     * KIND, either express or implied.  See the License for the
     * specific language governing permissions and limitations
     * under the License.
     */
    var app = {
        // Application Constructor
        initialize: function() {
            this.bindEvents();
        },
        // Bind Event Listeners
        //
        // Bind any events that are required on startup. Common events are:
        // 'load', 'deviceready', 'offline', and 'online'.
        bindEvents: function() {
            document.addEventListener('deviceready', this.onDeviceReady, false);
        },
        // deviceready Event Handler
        //
        // The scope of 'this' is the event. In order to call the 'receivedEvent'
        // function, we must explicitly call 'app.receivedEvent(...);'
        onDeviceReady: function() {
            connectDB();
            createTable(deviceReady);
        }
    };

    app.initialize();
</script>
</body>
</html>